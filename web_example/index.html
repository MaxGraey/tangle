<html>

<body>
    <canvas id="myCanvas" width="600" height="600"></canvas>

    <h1>Warp Core MVP</h1>
    <script src="room.js" type="module"></script>
    <script src="manager.js" type="module"></script>
    <script type="module">
        import { getWarpCore } from "./manager.js";
        let start_time = Date.now();

        async function run() {
            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");
            context.fillStyle = "blue";
            context.fillRect(0, 0, canvas.width, canvas.height);

            let wasm_binary = await fetch("example_script.wasm").then(response => response.arrayBuffer());
            let imports = {
                env: {
                    external_log: function (pointer, length) {
                        console.log("EXTERNAL LOG CALLED");
                        /*
                        const message_data = new Uint8Array(memory.buffer, pointer, length);
                        const decoded_string = decoder.decode(new Uint8Array(message_data));
                        console.log(decoded_string);
                        */
                    },
                    external_error: function (pointer, length) {
                        console.log("EXTERNAL ERROR CALLED");

                        // const message_data = new Uint8Array(memory.buffer, pointer, length);
                        // const decoded_string = decoder.decode(new Uint8Array(message_data));
                        // console.error(decoded_string);
                    },
                    draw_rect: function (r, g, b, a, x, y, w, h) {
                        context.fillStyle = `rgba(${r}, ${g}, ${b}, ${a})`;
                        context.fillStyle =
                            context.fillRect(x, y, w, h);
                    }
                }
            };

            let current_animation_time = Date.now();
            let warpcore = await getWarpCore(wasm_binary, imports,
                1000 / 60,
                // On Load
                async (time) => {
                    current_animation_time = time;
                    async function animation() {
                        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
                        // This is OK to use Date.now because the script doesn't actually edit
                        // anything (yet)
                        await warpcore.call_wasm("draw", [], Date.now());

                        // TODO: THIS IS SUPER WRONG AND WILL DESYNC IF PEERS HAVE FLAKEY CONNECTIONS
                        warpcore.remove_history(Date.now() - 2000);
                        window.requestAnimationFrame(animation);
                    }
                    await animation();
                },
                // On update
                async () => {
                    //await warpcore.call_wasm("draw", [], Date.now());
                });


            document.onkeydown = async (event) => {

                if (event.code == "ArrowLeft") {
                    await warpcore.call_wasm("left", [], Date.now());
                }

                if (event.code == "ArrowRight") {
                    await warpcore.call_wasm("right", [], Date.now());
                }

                if (event.code == "ArrowUp") {
                    await warpcore.call_wasm("up", [], Date.now());
                }

                if (event.code == "ArrowDown") {
                    await warpcore.call_wasm("down", [], Date.now());
                }

            };
        };
        run();
    </script>

</body>

</html>