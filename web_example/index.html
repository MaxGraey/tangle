<html>

<body>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    </head>

    <body style="margin:0; overflow-y: hidden;overflow-x: hidden; touch-action: none;">
        <canvas id="myCanvas" style="width:100vw; height: 100vh; "></canvas>
    </body>
    <script src="room.js" type="module"></script>
    <script src="manager.js" type="module"></script>
    <script type="module">
        import { getWarpCore } from "./manager.js";
        let start_time = Date.now();

        async function run() {
            const image = new Image(60, 45); // Using optional size for image
            image.src = "kenney_pixelplatformer/Tilemap/characters.png";

            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            window.onresize = function (event) {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
            }
            context.fillStyle = "blue";
            context.fillRect(0, 0, canvas.width, canvas.height);

            let wasm_binary = await fetch("example_script.wasm").then(response => response.arrayBuffer());
            let imports = {
                env: {
                    external_log: function (pointer, length) {
                        console.log("EXTERNAL LOG CALLED");
                        /*
                        const message_data = new Uint8Array(memory.buffer, pointer, length);
                        const decoded_string = decoder.decode(new Uint8Array(message_data));
                        console.log(decoded_string);
                        */
                    },
                    external_error: function (pointer, length) {
                        console.log("EXTERNAL ERROR CALLED");

                        // const message_data = new Uint8Array(memory.buffer, pointer, length);
                        // const decoded_string = decoder.decode(new Uint8Array(message_data));
                        // console.error(decoded_string);
                    },
                    draw_rect: function (r, g, b, a, x, y, w, h) {
                        context.fillStyle = `rgba(${r}, ${g}, ${b}, ${a})`;
                        context.fillStyle =
                            context.fillRect(x, y, w, h);
                    },
                    draw_circle: function (r, g, b, a, x, y, radius) {
                        context.fillStyle = `rgba(${r}, ${g}, ${b}, ${a})`;
                        context.beginPath();
                        context.arc(x, y, radius, 0, 2 * Math.PI);
                        context.fill();
                    },
                    draw_image: function (sx, sy, sw, sh, x, y, w, h) {
                        context.drawImage(image, sx, sy, 25, 25, x, y, w, h);
                    }
                }
            };

            let player_id = 0;
            let current_animation_time = Date.now();

            let fixed_update_rate = 1000 / 60;
            let warpcore = await getWarpCore(wasm_binary, imports,
                fixed_update_rate,
                // On Load
                async (time) => {

                    // TODO: This ID might change if this is rolled back.
                    player_id = 0;//await warpcore.call_wasm("add_player", [Math.random() * 255, Math.random() * 255, Math.random() * 255, Math.random() * 9], Date.now());
                    console.log("NEW PLAYER WITH ID: ", player_id);

                    current_animation_time = time;

                    async function animation() {
                        let time_now = Date.now();
                        let diff = time_now - current_animation_time;

                        let stop = (diff / fixed_update_rate) > 4;
                        if (stop) {
                            console.log("RUNNING SLOW");
                        }
                        /*
                        if ((diff / fixed_update_rate) > 4) {
                            fixed_update_rate *= 2;
                            console.log("SLOWING FIXED UPDATE TO: ", fixed_update_rate);
                            console.log("TIME DIFF: ", diff);
                            warpcore.set_recurring_call_interval(fixed_update_rate);
                        }
                        */

                        if (!stop) {
                            if (!warpcore.is_paused()) {
                                context.clearRect(0, 0, context.canvas.width, context.canvas.height);
                                // This is OK to use Date.now because the script doesn't actually edit
                                // anything (yet)
                                await warpcore.progress_time(time_now);


                                // TODO: THIS IS SUPER WRONG AND WILL DESYNC IF PEERS HAVE FLAKEY CONNECTIONS
                                warpcore.remove_history(time_now - 3000);
                            }

                        }
                        if (!stop) {
                            window.requestAnimationFrame(animation);
                        }

                        current_animation_time = time_now;
                    }
                    animation();
                },
                // On update
                async () => {
                    //await warpcore.call_wasm("draw", [], Date.now());
                });


            /*
        document.onkeydown = async (event) => {
    
            if (event.code == "ArrowLeft") {
                await warpcore.call_wasm("set_x_axis", [player_id, -1], Date.now());
            }
    
            if (event.code == "ArrowRight") {
                await warpcore.call_wasm("set_x_axis", [player_id, 1], Date.now());
            }
    
            if (event.code == "ArrowUp") {
                await warpcore.call_wasm("set_y_axis", [player_id, -1], Date.now());
            }
    
            if (event.code == "ArrowDown") {
                await warpcore.call_wasm("set_y_axis", [player_id, 1], Date.now());
            }
    
        };
        */

            document.onkeyup = async (event) => {

                if (event.code == "Digit1") {
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 15);
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 25);
                }

                /*
                if (event.code == "Digit2") {
                    // Left off: Reconstruct above sequence
                    await warpcore.log_hash();
                    await warpcore.call_wasm("add_ball", [1, 10, 13, 0.5, 12, 12, 12], 10);
                    console.log("AFTER add_ball 0 ");
                    await warpcore.log_hash();
    
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 15);
                    console.log("AFTER FIXED UPDATE 0");
                    await warpcore.log_hash();
    
                    await warpcore.call_wasm("add_ball", [1, 10, 13, 0.5, 12, 12, 12], 20);
                    console.log("AFTER add_ball 1");
                    await warpcore.log_hash();
    
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 25);
                    console.log("AFTER FIXED UPDATE 1");
                    await warpcore.log_hash();
                }
    
                if (event.code == "Digit3") {
                    // Left off: Reconstruct above sequence
    
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 15);
                    await warpcore.call_wasm_unnetworked("fixed_update", [], 25);
    
                    console.log("INSERTING EVENTS");
                    //  await warpcore.rewind(10);
                    console.log("HERE0");
                    await warpcore.log_hash();
                    await warpcore.call_wasm_unnetworked("add_ball", [1, 10, 13, 0.5, 12, 12, 12], 10);
                    console.log("HERE1");
                    await warpcore.log_hash();
    
                    await warpcore.call_wasm_unnetworked("add_ball", [1, 10, 13, 0.5, 12, 12, 12], 20);
                    console.log("HERE2");
                    await warpcore.log_hash();
                }
                */



                /*
                if (event.code == "KeyH") {
                    await warpcore.log_hash();
                }

                if (event.code == "KeyD") {
                    await warpcore.call_wasm("add_ball", [player_id, Math.random() * canvas.width, Math.random() * canvas.height, Math.random(), Math.random() * 255, Math.random() * 255, Math.random() * 255], window.last_wasm_sent_time - 10);
                }

                if (event.code == "KeyF") {
                    await warpcore.call_wasm_unnetworked("fixed_update", [], window.last_wasm_sent_time - 10);
                }

                if (event.code == "KeyA") {
                    await warpcore.call_wasm("add_ball", [player_id, Math.random() * canvas.width, Math.random() * canvas.height, Math.random(), Math.random() * 255, Math.random() * 255, Math.random() * 255], Date.now());
                    context.clearRect(0, 0, context.canvas.width, context.canvas.height);
                    await warpcore.call_wasm("draw", [], Date.now());
                }
                */

                if (event.code == "KeyP") {
                    warpcore.toggle_pause(Date.now());
                }
                if (event.code == "KeyF") {
                    warpcore.log_function_calls();
                }
            };

            canvas.onpointerdown = async (event) => {

                await warpcore.call_wasm("add_ball", [player_id, event.clientX, event.clientY, Math.random(), Math.random() * 255, Math.random() * 255, Math.random() * 255], Date.now());
            };
        };
        run();
    </script>

</body>

</html>